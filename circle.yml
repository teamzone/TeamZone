machine:
  node:
    version: 0.10.30
    
  environment:
    REDISTOGO_URL: redis://rediscloud:c5DS4STm0sBTQNZS@pub-redis-14750.us-east-1-4.2.ec2.garantiadata.com:14750
    TEAMZONE_URL: https://circleci-cibuild.herokuapp.com

general:
  artifacts:
    - "Coverage.html" 
    
test:
  pre:
    - npm install -g grunt-cli
    
dependencies:
  post:
    - wget https://saucelabs.com/downloads/sc-latest-linux.tar.gz
    - tar -xzf sc-latest-linux.tar.gz
    
deployment:
  dev:
    branch: master
    heroku:
      appname: circleci-cibuild
  uit:
    branch: UIT
    commands:
      - git push git@heroku.com:circleci-cibuild.git $CIRCLE_SHA1:master
      - heroku run rake db:migrate --app circleci-cibuild    
      - ./bin/sc -u $SAUCE_USERNAME -k $SAUCE_ACCESS_KEY -f ~/sc_ready:
          background: true
          pwd: sc-*-linux
      # Wait for tunnel to be ready
      - while [ ! -e ~/sc_ready ]; do sleep 1; done 
      # Wait for app to be ready
      - curl --retry 10 --retry-delay 2 -v $TEAMZONE_URL    
      - grunt uitbuild --force
    
  staging:
      branch: staging
      heroku:
        appname: circleci-cibuild-staging  

  